<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-label/iron-label.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-request.html">
<link rel="import" href="../../bower_components/iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-behavior/paper-dialog-behavior.html">
<link rel="imoprt" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/google-map/google-map.html">
<link rel="import" href="../../bower_components/google-map/google-map-marker.html">
<link rel="import" href="../../bower_components/google-map/google-map-search.html">
<link rel="import" href="../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../bower_components/datetime-picker/datetime-shared-style.html">
<link rel="import" href="../../bower_components/datetime-picker/datetime-input.html">
<link rel="import" href="../../bower_components/datetime-picker/date-picker.html">
<link rel="import" href="../../bower_components/datetime-picker/datetime-picker.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-query.html">

<!-- Google API Key: AIzaSyBlgE4O9hgijK1uAOARzCsP7zg3JICHybo -->

<dom-module id="my-events">
    <template>

        <iron-ajax
                id="boardGameSearchAjax"
                url="https://boardgamegeek.com/xmlapi2/search"
                params='{{searchParam}}'
                handle-as="document"
                on-response="_handleSearchResponse"></iron-ajax>

        <iron-ajax
                id="boardGameIdAjax"
                url="https://bgg-json.azurewebsites.net/thing/{{idParam}}"
                handle-as="json"
                on-response="_handleJsonResponse"></iron-ajax>

        <iron-ajax
                id="locationAjax"
                url="https://maps.googleapis.com/maps/api/geocode/json?"
                params='{{locationParam}}'
                handle-as="json"
                on-response="_handleLocationResponse"></iron-ajax>

        <div class="card">
            <div class="layout horizontal">
                <h1 class="flex">Events</h1>
                <iron-icon class="card-actions" icon="add" on-click="openDia"></iron-icon>
            </div>
        </div>

        <div>
            <paper-dialog id="pickGame" modal on-iron-overlay-opened="patchOverlay">
                <div class="inputs">
                    <paper-input id="gameName" label="Game Name" value="{{boardName}}"></paper-input>
                    <paper-button on-click="searchGame">Search</paper-button>
                    <paper-button dialog-dismiss>Cancel</paper-button>
                </div>
                <iron-list items="[[bgResults]]" as="item">
                    <template>
                        <div>
                            <paper-button on-tap="_selectGameId" data-item$="[[item.id]]">[[item.name]]</paper-button>
                        </div>
                    </template>
                </iron-list>
            </paper-dialog>

            <paper-dialog id="pickLocation" modal on-iron-overlay-opened="patchOverlay">
                <paper-input id="location" label="Location" value="{{location}}"></paper-input>
                <paper-button on-click="searchLocation">Search</paper-button>
                <iron-list items="[[locResults]]" as="item">
                    <template>
                        <div>
                            <paper-button on-tap="_selectLocation" data-item$="[[item]]">[[item.address]]</paper-button>
                        </div>
                    </template>
                </iron-list>
            </paper-dialog>

            <paper-dialog id="otherDetails" modal on-iron-overlay-opened="patchOverlay" on-iron-overlay-closed="closeOtherDetails">
                <div id="selectedDetails" class="layout vertical">
                    <label id="selectedName"></label>
                    <label id="selectedMin"></label>
                    <label id="selectedMax"></label>
                </div>
                <div class="inputs">
                    <vaadin-date-picker label="Date of Event"></vaadin-date-picker><br>
                    <time-element time="{{time}}"></time-element>

                </div>
                <div class="buttons">
                    <paper-button dialog-confirm>Add Event</paper-button>
                    <paper-button dialog-dismiss>Cancel</paper-button>
                </div>
            </paper-dialog>
        </div>

        <style include="iron-flex iron-flex-alignment iron-flex-factors iron-flex-reverse"></style>
        <style include="shared-styles">
            :host {
                display: block;
                padding: 10px;
            }

            google-map {
                height: 200px;
                width: 300px;
            }

            iron-icon {
                cursor: pointer;
            }

            paper-dialog {
                padding: 180px;
            }

            time-element {
                padding: 8px;
            }

            iron-list {
                height: 40vh;
            }

            paper-button {
                width: 100%;
            }

        </style>
    </template>

    <script>

        class MyEvents extends Polymer.Element {
            static get is() {
                return 'my-events';
            }

            static get properties() {
                return {
                    searchParam: {
                        type: String,
                        computed: '_processParam(boardName)'
                    },

                    idParam: {
                        type: String
                    },

                    locationParam: {
                        type: String,
                        computed: '_processLocation(location)'
                    },

                    bgResults: {
                        type: Array,
                        value: []
                    },

                    locResults: {
                        type: Array,
                        value: []
                    },

                    longitude: {
                        type: String
                    },

                    latitude: {
                        type: String
                    }
                };
            }

            _processParam(boardName) {
                return {"query":boardName, "type":"boardgame"};
            }

            _selectGameId(event) {
                this.set("idParam", event.target.dataset.item);
                this.$.boardGameIdAjax.generateRequest();
                this.$.pickGame.close();
                this.$.pickLocation.open();
            }

            _selectLocation(event) {
                this.set("longitude", event.target.dataset.item.long);
                this.set("latitude", event.target.dataset.item.lat);
                this.$.pickLocation.close();
                this.$.otherDetails.open();
            }

            _processLocation(location) {
                return {"address":location};
            }

            _handleSearchResponse(event) {
                var response = event.detail.response;
                var resultsLen = response.getElementsByTagName("items")[0].getElementsByTagName("item").length;
                this.splice("bgResults", 0, this.bgResults.length); //Clear out old results.

                if(resultsLen != 0) {
                    //Fill array with names and IDs.
                    for (var i = 0; i < resultsLen; i++) {
                        var res = {
                            name: response.getElementsByTagName("items")[0].getElementsByTagName("item")[i]
                                .getElementsByTagName("name")[0].getAttribute("value"), id: response
                                .getElementsByTagName("items")[0].getElementsByTagName("item")[i].getAttribute("id")
                        };
                        this.push("bgResults", res);
                    }
                } else {
                    this.push("bgResults", "No Results");
                }
                console.log(this.bgResults);
            }

            _handleJsonResponse(event) {
                var response = event.detail.response;
                console.log(response);

                this.$.selectedName.innerHTML = "Game: " + response.name;
                this.$.selectedMin.innerHTML = "Minimum Players: " + response.minPlayers;
                this.$.selectedMax.innerHTML = "Maximum Players: " + response.maxPlayers;
            }

            _handleLocationResponse(event) {
                var response = event.detail.response;

                var resultsLen = response.results.length;
                this.splice("locResults", 0, this.locResults.length); //Clear out old results.

                if(resultsLen != 0) {
                    //Fill array with locations.
                    for (var i = 0; i < resultsLen; i++) {
                        var res = {address: response.results[i].formatted_address,
                            long: response.results[i].geometry.location.lng,
                            lat: response.results[i].geometry.location.lat};
                        this.push("locResults", res);
                    }
                } else {
                    this.push("locResults", "No Results");
                }
                console.log(this.locResults);
            }

            searchLocation() {
                this.$.locationAjax.generateRequest();
            }

            searchGame() {
                this.$.boardGameSearchAjax.generateRequest();
            }

            openDia() {
                this.$.pickGame.open();
            }

            closeOtherDetails() {
                if(this.$.otherDetails.closingReason.confirmed) {
                    //Store fb stuff.
                }
            }

            patchOverlay(e) {
                if(e.target.withBackdrop) {
                    e.target.parentNode.insertBefore(e.target.backdropElement, e.target);
                }
            }
        }

        window.customElements.define(MyEvents.is, MyEvents);
    </script>
</dom-module>