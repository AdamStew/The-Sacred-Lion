<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-label/iron-label.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-request.html">
<link rel="import" href="../../bower_components/iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-behavior/paper-dialog-behavior.html">
<link rel="import" href="../../bower_components/google-map/google-map.html">
<link rel="import" href="../../bower_components/good-map/good-map.html">
<link rel="import" href="../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../bower_components/datetime-picker/datetime-shared-style.html">
<link rel="import" href="../../bower_components/datetime-picker/datetime-input.html">
<link rel="import" href="../../bower_components/datetime-picker/date-picker.html">
<link rel="import" href="../../bower_components/datetime-picker/datetime-picker.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-query.html">

<dom-module id="my-events">
    <template>

        <iron-ajax
                id="boardGameSearchAjax"
                url="https://boardgamegeek.com/xmlapi2/search"
                params='{{searchParam}}'
                handle-as="document"
                on-response="_handleSearchResponse"></iron-ajax>

        <iron-ajax
                id="boardGameIdAjax"
                url="https://bgg-json.azurewebsites.net/thing/{{idParam}}"
                handle-as="json"
                on-response="_handleJsonResponse"></iron-ajax>

        <div class="card">
            <div class="layout horizontal">
                <h1 class="flex">Events</h1>
                <iron-icon class="card-actions" icon="add" on-click="openDia"></iron-icon>
            </div>
        </div>

        <div>
            <paper-dialog id="pickGame" modal on-iron-overlay-opened="patchOverlay">
                <div class="inputs">
                    <paper-input id="gameName" label="Game Name" value="{{boardName}}"></paper-input>
                    <paper-button on-click="searchGame">Search</paper-button>
                </div>
                <iron-list items="[[results]]" as="item">
                    <template>
                        <div>
                            <paper-button on-tap="_selectGameId" data-item$="[[item.id]]">[[item.name]]</paper-button>
                        </div>
                    </template>
                </iron-list>
            </paper-dialog>

            <paper-dialog id="otherDetails" modal on-iron-overlay-opened="patchOverlay" on-iron-overlay-closed="closeOtherDetails">
                <div class="inputs">
                    <vaadin-date-picker label="Date of Event"></vaadin-date-picker><br>
                    <time-element time="{{time}}"></time-element>
                </div>
                <div class="buttons">
                    <paper-button dialog-confirm>Add Event</paper-button>
                    <paper-button dialog-dismiss>Cancel</paper-button>
                </div>
            </paper-dialog>
        </div>

        <style include="iron-flex iron-flex-alignment iron-flex-factors iron-flex-reverse"></style>
        <style include="shared-styles">
            :host {
                display: block;
                padding: 10px;
            }

            iron-icon {
                cursor: pointer;
            }

            paper-dialog {
                padding: 180px;
            }

            time-element {
                padding: 8px;
            }

            iron-list {
                height: 40vh;
            }

            paper-button {
                width: 100%;
            }

        </style>
    </template>

    <script>

        class MyEvents extends Polymer.Element {
            static get is() {
                return 'my-events';
            }

            static get properties() {
                return {
                    searchParam: {
                        type: String,
                        computed: '_processParam(boardName)'
                    },

                    idParam: {
                        type: String
                    },

                    results: {
                        type: Array,
                        value: []
                    }
                };
            }

            _processParam(boardName) {
                return {"query":boardName, "type":"boardgame"};
            }

            _selectGameId(event) {
                this.set("idParam", event.target.dataset.item);
                this.$.boardGameIdAjax.generateRequest();
                this.$.pickGame.close();
                this.$.otherDetails.open();
            }

            _handleSearchResponse(event) {
                var response = event.detail.response;
                var resultsLen = response.getElementsByTagName("items")[0].getElementsByTagName("item").length;
                this.splice("results", 0, this.results.length); //Clear out old results.

                //Fill array with names and IDs.
                for(var i=0; i < resultsLen; i++) {
                    var res = {name: response.getElementsByTagName("items")[0].getElementsByTagName("item")[i]
                        .getElementsByTagName("name")[0].getAttribute("value"), id: response
                        .getElementsByTagName("items")[0].getElementsByTagName("item")[i].getAttribute("id")};
                    this.push("results", res);
                }
                console.log(this.results);
            }

            _handleJsonResponse(event) {
                var response = event.detail.response;
                console.log(response);
            }

            searchGame() {
                this.$.boardGameSearchAjax.generateRequest();
            }

            openDia() {
                this.$.pickGame.open();
            }

            closeOtherDetails() {
                if(this.$.otherDetails.closingReason.confirmed) {
                    //Store fb stuff.
                }
            }

            patchOverlay(e) {
                if(e.target.withBackdrop) {
                    e.target.parentNode.insertBefore(e.target.backdropElement, e.target);
                }
            }
        }

        window.customElements.define(MyEvents.is, MyEvents);
    </script>
</dom-module>